//AUTOGENERATED CODE DO NOT EDIT
// This file is automatically generated from /internal/codegen/templates/s3_parquet_dao.tmpl
package s3parquet

import (
    "context"
    "fmt"
    awsS3 "github.com/aws/aws-sdk-go-v2/service/s3"
    "github.com/sheacloud/cloud-inventory/pkg/meta"
{{range $index, $element := .Services}}	"github.com/sheacloud/cloud-inventory/pkg/aws/{{$element.Name}}"
{{end}}
)

type S3ParquetWriterDAO struct {
    parquetClient *S3ParquetClient
}

func NewS3ParquetWriterDAO(s3Client *awsS3.Client, bucket string, numProcessors int64) *S3ParquetWriterDAO {
    return &S3ParquetWriterDAO{
        parquetClient: NewS3ParquetClient(s3Client, bucket, numProcessors),
    }
}

func (dao *S3ParquetWriterDAO) WriteInventoryResults(ctx context.Context, metadata *meta.InventoryResults) error {
    file, err := dao.parquetClient.GetResourceFile(ctx, []string{"meta", "inventory_results"}, metadata.ReportTime, metadata)
	if err != nil {
		return err
	}
	file.Lock.Lock()
	defer file.Lock.Unlock()

	if err := file.Write(metadata); err != nil {
		return fmt.Errorf("failed to write inventory results: %w", err)
	}

	return nil
}

func (dao *S3ParquetWriterDAO) WriteIngestionTimestamp(ctx context.Context, metadata *meta.IngestionTimestamp) error {
    file, err := dao.parquetClient.GetResourceFile(ctx, []string{"meta", "ingestion_timestamps"}, metadata.ReportTime, metadata)
	if err != nil {
		return err
	}
	file.Lock.Lock()
	defer file.Lock.Unlock()

	if err := file.Write(metadata); err != nil {
		return fmt.Errorf("failed to write ingestion timestamp: %w", err)
	}

	return nil
}

func (dao *S3ParquetWriterDAO) FinishIndex(ctx context.Context, indices []string, reportDateUnixMilli int64) error {
    return dao.parquetClient.FinishIndex(ctx, indices, reportDateUnixMilli)
}

func (dao *S3ParquetWriterDAO) Finish(ctx context.Context) error {
    return dao.parquetClient.CloseAll(ctx)
}

{{range $serviceIndex, $serviceElement := .Services}}{{range $resourceIndex, $resourceElement := $serviceElement.Resources}}func (dao *S3ParquetWriterDAO) PutAws{{$serviceElement.ServiceCapName}}{{$resourceElement.ObjectPluralName}}(ctx context.Context, resources []*{{$serviceElement.Name}}.{{$resourceElement.ObjectSingularName}}) error {
    if len(resources) == 0 {
        return nil
    }
    file, err := dao.parquetClient.GetResourceFile(ctx, []string{"aws", "{{$serviceElement.Name}}", "{{$resourceElement.ObjectPluralSnakeName}}"}, resources[0].ReportTime, resources[0])
    if err != nil {
        return err
    }
    file.Lock.Lock()
    defer file.Lock.Unlock()

    for _, resource := range resources {
        if err := file.Write(resource); err != nil {
            return fmt.Errorf("failed to write resource: %w", err)
        }
    }

    return nil
}
{{end}}{{end}}